# Simulink Model Conversion and Mayhem for Code Fuzzing

This document explains how to use MATLAB to convert a mayhemit.slx Simulink model to C code, compile it, and perform fuzzing tests using Mayhem for Code.

## Prerequisites

- MATLAB with Simulink installed.
- Docker installed and running.
- Mayhem for Code account and CLI tool installed.

## Steps

### 1. Create the .env file

To set up the environment variables required for the shell script, you need to create a .env file in your project directory. This file should contain the following environment variables:

```
MAYHEM_TOKEN
MAYHEM_URL
MAYHEM_USERNAME
```

Replace the empty double quotes with your actual Mayhem for Code token, URL, and username.

For example:

```
MAYHEM_TOKEN="your_mayhem_token"
MAYHEM_URL="https://your_mayhem_url"
MAYHEM_USERNAME="your_mayhem_username"
```

Save the .env file in your project directory, and the shell script will load the environment variables from this file.

> **Important**: Make sure not to include the .env file in your version control system (e.g., add it to your .gitignore file), as it contains sensitive information.

### 2. Convert Simulink Model to C Code

Just execute the provided shell script `run_mcode.sh` to complete the remaining steps.

The script contains the following command to convert the mayhemit.slx Simulink model to C code:

```
"$MATLAB_PATH/matlab" -nodisplay -nosplash -nodesktop -r " \
    try, \
        open_system('$MODEL_NAME'), \
        set_param('$MODEL_NAME', 'RTWVerbose', 'off'), \
        set_param('$MODEL_NAME', 'SolverType', 'Fixed-step'), \
        set_param('$MODEL_NAME', 'FixedStep', 'auto'), \
        slbuild('$MODEL_NAME'), \
        close_system('$MODEL_NAME', 0), \
        exit(0), \
    catch ME, \
        fprintf(2, 'Error: %s\n', getReport(ME, 'extended', 'hyperlinks', 'off')), \
        exit(1), \
    end"
```

This command uses MATLAB and Simulink to generate C code for the mayhemit.slx model.

> **Note**: MATLAB will need to be added to the path in order for this step to execute properly.

### 3. Compile the C Code

The shell script will compile the C code using Docker. The Dockerfile should include the necessary steps to compile the code and create the binary. The script will then push the compiled binary to your Mayhem for Code account.

### 4. Fuzz the Code with Mayhem for Code

The shell script will use the Mayhem CLI to fuzz the code for 90 seconds, as specified in the `--duration 90` flag.


```
mayhem-${ARCH} --verbosity info run . --project $NAME --owner ${MAYHEM_USERNAME} --image ${IMAGE} --file ${MAYHEMFILE} --duration 90
```


## Additional Files

### ertc_main.c

The ertc_main.c file in the resources folder will read a file as a command-line argument and pass its contents to the mayhemit function. This will be compiled along with the C code generated by MATLAB and Simulink.
