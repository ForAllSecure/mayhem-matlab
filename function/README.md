# MATLAB Coder Conversion and Mayhem for Code Fuzzing

This document explains how to use MATLAB Coder to convert a `mayhemit.m` function to C code, compile it, and perform fuzzing tests using Mayhem for Code.

## Prerequisites

1. MATLAB with MATLAB Coder installed.
2. Docker installed and running.
3. Mayhem for Code account and CLI tool installed.

## Steps

## 1. Create the .env file

To set up the environment variables required for the shell script, you need to create a `.env` file in your project directory. This file should contain the following environment variables:

```
MAYHEM_TOKEN
MAYHEM_URL
MAYHEM_USERNAME
```

Replace the empty double quotes with your actual Mayhem for Code token, URL, and username.

For example:

```
MAYHEM_TOKEN="your_mayhem_token"
MAYHEM_URL="https://your_mayhem_url"
MAYHEM_USERNAME="your_mayhem_username"
```

Save the `.env` file in your project directory, and the shell script will load the environment variables from this file.

**Important**: Make sure not to include the `.env` file in your version control system (e.g., add it to your `.gitignore` file), as it contains sensitive information.

### 2. Convert MATLAB Code to C Code

Just execute the provided shell script `run_mcode.sh` to completed the remaining steps. 

The script contains the following command to convert the `mayhemit.m` function to C code:

```
matlab -nodesktop -nosplash -r "matlabrc; cfg = coder.config('lib'); cfg.TargetLang = 'C'; codegen mayhemit -config cfg -args {coder.typeof(' ', [1 inf])}; exit;"
```

This command uses MATLAB Coder to generate C code for the `mayhemit.m` function, which takes a char array of length [1:inf] as input.

**Note**: MATLAB will needed to be added to path in order for this step to execute properly.


### Alternative Step 2. Convert MATLAB Code to C Code Using MATLAB Coder GUI

This alternative step explains how to use the GUI version of MATLAB Coder to convert the `mayhemit.m` function to C code. The instructions are up to date for the most recent version of MATLAB. If you choose to use the MATLAB GUI you will need to comment out the matlab code generate line in `run_mcode.sh`

1. Open MATLAB, and in the `Apps` tab, click `MATLAB Coder`.

2. In the MATLAB Coder window, click `Next`.

3. Enter the function name `mayhemit` in the `Function Name` field.

4. Click `Next`. Leave the entry-point function and project location as default.

5. In the `Define Input Types` screen, enter `mayhemit(['t','e','s','t'])` in the provided field to automatically define input types.

6. Change the input type from the default to `char(1 x inf)`.

7. Click `Next`.

8. In the `Check for Run-Time Issues` screen, click `Check for Issues`. All three checkboxes should turn green.

9. Click `Next`.

10. In the `Generate Code` screen, make sure the `Language` is set to `C`.

11. Click `Generate`.

12. Click `Next`, and then click `Next` again.

13. In the `Finish Workflow` screen, you should see `Source Code Generated Successfully`. Click the `x` button to close the window.

After completing these steps, you will have successfully converted the `mayhemit.m` function to C code using the MATLAB Coder GUI.

### 3. Compile the C Code

The shell script will compile the C code using Docker. The `Dockerfile` should include the necessary steps to compile the code and create the binary. The script will then push the compiled binary to your Mayhem for Code account.

### 4. Fuzz the Code with Mayhem for Code

The shell script will use the Mayhem CLI to fuzz the code for 90 seconds, as specified in the `--duration 90` flag.

```
mayhem-${ARCH} --verbosity info run . --project $NAME --owner ${MAYHEM_USERNAME} --image ${IMAGE} --file ${MAYHEMFILE} --duration 90
```

## Main.c

The `main.c` file in the `resources` folder will read a file as a command-line argument and pass its contents to the `mayhemit` function. This will be compiled along with the C code generated by MATLAB Coder.

## Summary

After completing these steps, you will have successfully converted the `mayhemit.m` function to C code, compiled it, and performed fuzzing tests using Mayhem for Code.

Refer to the [Mayhem for Code documentation](https://mayhem.forallsecure.com/docs/) for more information on using the Mayhem CLI and interpreting the results